#!/bin/bash

# define course/repository name/year
COURSE=hbigs_course_2022

# Do not modify below
# -----------------------------------------------
# Install packages in a fresh virtual environment

ARR=(${COURSE//_/ })
NAME="${ARR[0]}${ARR[2]}"

# course github directory
PARENT=$HOME/$COURSE/part3_Riboseq

# create virtual environment
ENVLOC=$PARENT/envs
if [[ -L "${ENVLOC}" && -d "${ENVLOC:+$ENVLOC/}" ]]; then
 echo "[ERROR]: Directory already exists!"
 exit 1
fi
mkdir $ENVLOC
python3 -m venv $ENVLOC/${NAME^^}-ribo
# activate the environment
source $ENVLOC/${NAME^^}-ribo/bin/activate
# upgrade pip and wheel
pip3 install --upgrade pip setuptools wheel

# clone the git repository and install rpbp
cd $PARENT
git clone https://github.com/dieterich-lab/rp-bp.git
cd rp-bp
pip3 --verbose install -r requirements.txt . 2>&1 | tee rpbp-install.log

# also install slurm magic for jupyter notebook
cd $PARENT
git clone https://github.com/NERSC/slurm-magic.git
cd slurm-magic
pip3 --verbose install . 2>&1 | tee slurm-magic-install.log

# add jupyter kernel for this environment
pip3 install ipykernel
python3 -m ipykernel install --user --name="${NAME^^}-ribo"

# deactivate the environment
deactivate

# set-up directory structure for the analysis
# we will write remaining files together... and run the analysis 
# via a jupyter notebook
DIRLOC=riboSeq${NAME^^}-downsampled-analysis
cd $PARENT
mkdir -p $DIRLOC/config $DIRLOC/riboseq-results

